<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Generator</title>

    <link rel="icon" type="image/x-icon" href="favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Group Gen">

    <style>
        :root {
            --primary: #1a73e8;
            --secondary: #5f6368;
            --success: #34a853;
            --bg: #f8f9fa;
        }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            max-width: 900px; 
            margin: 20px auto; 
            padding: 20px; 
            background: var(--bg); 
            color: #333; 
            font-size: 16px;
        }

        .container { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }

        h2 { color: var(--primary); margin-top: 0; font-size: 1.8rem; }
        
        #inputSection { margin-bottom: 20px; }
        textarea { 
            width: 100%; 
            height: 150px; 
            padding: 15px; 
            border: 2px solid #dfe1e5; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 16px; /* Prevents iOS zoom on focus */
        }
        
        .controls { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            margin-bottom: 25px; 
        }

        button { 
            flex: 1;
            min-width: 150px;
            padding: 16px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 1rem;
            transition: transform 0.1s, opacity 0.2s; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        button:active { transform: scale(0.98); }

        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-export { background: var(--success); color: white; }

        .output-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
        }

        .group-card { 
            background: #fff; 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #dadce0; 
        }

        .group-title { 
            font-weight: bold; 
            color: var(--primary); 
            display: block; 
            margin-bottom: 12px; 
            border-bottom: 1px solid #eee; 
            font-size: 1.2rem;
        }
        
        .student-item { 
            margin-bottom: 8px; 
            display: flex; 
            justify-content: space-between;
            font-size: 1.1rem;
        }

        /* Visibility Logic */
        .grade-val, .avg-val { 
            font-size: 0.9em; 
            padding: 2px 8px; 
            border-radius: 4px; 
            background: #e8f0fe; 
            color: #1967d2; 
        }

        .avg-container { 
            margin-top: 15px; 
            font-weight: bold; 
            color: #555; 
            border-top: 1px dashed #eee; 
            padding-top: 10px; 
        }

        /* Presentation Mode */
        body.presentation-mode #inputSection, 
        body.presentation-mode .btn-primary,
        body.presentation-mode .grade-val, 
        body.presentation-mode .avg-container { 
            display: none !important; 
        }

        /* Mobile Specific Adjustments */
        @media (max-width: 600px) {
            body { padding: 10px; margin: 10px auto; }
            .controls { flex-direction: column; }
            button { width: 100%; flex: none; padding: 20px; font-size: 1.1rem; }
            .group-card { padding: 15px; }
        }

        /* Modal */
        #exportModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; padding: 20px; box-sizing: border-box; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 500px; }
        #exportArea { width: 100%; height: 200px; margin-bottom: 15px; }
        .modal-footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Group Generator</h2>
    
    <div id="inputSection">
        <textarea id="inputData" placeholder="Paste names and grades from your spreadsheet here..."></textarea>
    </div>
    
    <div class="controls">
        <button class="btn-primary" onclick="generateGroups()">Sort Groups</button>
        <button class="btn-secondary" id="presBtn" onclick="togglePresentation()">Presentation Mode</button>
        <button class="btn-export" onclick="exportForClassroom()">Export</button>
    </div>

    <div id="output" class="output-container"></div>
</div>

<div id="exportModal">
    <div class="modal-content">
        <h3>Classroom Export</h3>
        <textarea id="exportArea" readonly></textarea>
        <div class="modal-footer">
            <div>
                <button class="btn-primary" id="copyBtn" onclick="copyToClipboard()" style="min-width: 100px;">Copy</button>
                <span id="copyFeedback" style="display:none; color: var(--success); font-weight: bold; margin-left: 10px;">Copied!</span>
            </div>
            <button class="btn-secondary" onclick="document.getElementById('exportModal').style.display='none'" style="min-width: 100px;">Close</button>
        </div>
    </div>
</div>

<script>
    let currentGroups = [];

    function togglePresentation() {
        document.body.classList.toggle('presentation-mode');
        const isPres = document.body.classList.contains('presentation-mode');
        document.getElementById('presBtn').innerText = isPres ? 'Exit Presentation' : 'Presentation Mode';
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function generateGroups() {
        const input = document.getElementById('inputData').value.trim();
        if (!input) return;

        let students = input.split('\n').map(line => {
            const parts = line.split(/\t| {2,}/);
            if (parts.length < 2) return null;
            return { name: parts[0].trim(), grade: parseFloat(parts[1].trim()) };
        }).filter(s => s && !isNaN(s.grade));

        if (students.length < 2) return alert("Please enter more students.");

        students.sort((a, b) => b.grade - a.grade);
        let n = students.length;
        let num3s = 0, num2s = 0;
        if (n % 3 === 0) num3s = n / 3;
        else if (n % 3 === 2) { num3s = Math.floor(n / 3); num2s = 1; }
        else if (n % 3 === 1) { num3s = Math.floor(n / 3) - 1; num2s = 2; }

        let high = students.slice(0, num3s + num2s);
        let mid = students.slice(num3s + num2s, (num3s * 2) + num2s);
        let low = students.slice((num3s * 2) + num2s);

        shuffle(high); shuffle(mid); shuffle(low);

        currentGroups = [];
        for (let i = 0; i < num3s; i++) currentGroups.push([high.pop(), mid.pop(), low.pop()]);
        for (let i = 0; i < num2s; i++) currentGroups.push([high.pop(), low.pop()]);

        // Optimization Loop
        const getAvg = g => g.reduce((s, v) => s + v.grade, 0) / g.length;
        const getSpread = grps => {
            let avgs = grps.map(g => getAvg(g));
            return Math.max(...avgs) - Math.min(...avgs);
        };

        for (let i = 0; i < 2000; i++) {
            let g1 = Math.floor(Math.random() * currentGroups.length);
            let g2 = Math.floor(Math.random() * currentGroups.length);
            if (g1 === g2) continue;
            let s1 = Math.floor(Math.random() * currentGroups[g1].length);
            let s2 = Math.floor(Math.random() * currentGroups[g2].length);
            let currentSpread = getSpread(currentGroups);
            let temp = currentGroups[g1][s1];
            currentGroups[g1][s1] = currentGroups[g2][s2];
            currentGroups[g2][s2] = temp;
            if (getSpread(currentGroups) >= currentSpread) {
                let back = currentGroups[g1][s1];
                currentGroups[g1][s1] = currentGroups[g2][s2];
                currentGroups[g2][s2] = back;
            }
        }

        currentGroups.forEach(g => shuffle(g));
        shuffle(currentGroups);
        renderGroups(getAvg);
    }

    function renderGroups(getAvgFn) {
        const out = document.getElementById('output');
        out.innerHTML = '';
        currentGroups.forEach((group, i) => {
            const card = document.createElement('div');
            card.className = 'group-card';
            card.innerHTML = `
                <span class="group-title">Group ${i + 1}</span>
                <div class="student-list">${group.map(s => `
                    <div class="student-item"><span>${s.name}</span> <span class="grade-val">${s.grade}</span></div>
                `).join('')}</div>
                <div class="avg-container">Group Avg: <span class="avg-val">${getAvgFn(group).toFixed(1)}</span></div>
            `;
            out.appendChild(card);
        });
    }

    function exportForClassroom() {
        if (currentGroups.length === 0) return;
        let text = "Classroom Groups:\n\n";
        currentGroups.forEach((group, i) => {
            text += `GROUP ${i + 1}\n` + group.map(s => `- ${s.name}`).join('\n') + "\n\n";
        });
        document.getElementById('exportArea').value = text;
        document.getElementById('exportModal').style.display = 'flex';
        document.getElementById('copyFeedback').style.display = 'none';
    }

    function copyToClipboard() {
        const area = document.getElementById("exportArea");
        area.select();
        navigator.clipboard.writeText(area.value);
        document.getElementById('copyFeedback').style.display = 'inline';
    }
</script>
</body>
</html>
