<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Generator Pro</title>
    <style>
        :root {
            --primary: #1a73e8; --secondary: #5f6368; --success: #34a853; --danger: #d93025;
            --purple: #673ab7; --purple-hover: #5e35b1;
            --bg: #f8f9fa; --container-bg: #ffffff; --text: #333333;
            --card-bg: #ffffff; --card-border: #dadce0; --input-border: #dfe1e5;
            --shadow: rgba(0, 0, 0, 0.08);
        }
        [data-theme="dark"] {
            --bg: #121212; --container-bg: #1e1e1e; --text: #e0e0e0;
            --card-bg: #2d2d2d; --card-border: #404040; --input-border: #404040;
            --shadow: rgba(0, 0, 0, 0.3); --primary: #8ab4f8; --purple: #b39ddb;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; max-width: 1100px; margin: 20px auto; padding: 20px; background: var(--bg); color: var(--text); transition: opacity 0.4s ease; }
        .container { background: var(--container-bg); padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px -5px var(--shadow); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

        .grid-layout { display: flex; gap: 25px; margin-bottom: 20px; height: 350px; }
        .editor-container { position: relative; flex: 1; height: 100%; }
        #inputData, #stealthOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 15px; border: 2px solid var(--input-border); border-radius: 8px;
            font-size: 16px; font-family: monospace; box-sizing: border-box;
            white-space: pre-wrap; line-height: 1.5; margin: 0;
        }
        #inputData { color: transparent; caret-color: var(--text); background: transparent; z-index: 2; resize: none; }
        #stealthOverlay { background: var(--card-bg); color: var(--text); z-index: 1; pointer-events: none; overflow-y: auto; }
        .ghost-num { color: transparent; text-shadow: 0 0 8px rgba(0,0,0,0.02); }

        .sidebar { background: var(--bg); padding: 15px; border-radius: 8px; border: 1px solid var(--card-border); width: 250px; display: flex; flex-direction: column; }
        #savedList { overflow-y: auto; flex-grow: 1; }
        .saved-item { display: flex; justify-content: space-between; padding: 8px; margin-bottom: 5px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 6px; cursor: pointer; }

        .settings-bar { display: flex; align-items: center; gap: 10px; margin: 20px 0; padding: 15px; background: var(--bg); border-radius: 8px; border: 1px solid var(--card-border); }

        .controls { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .controls button { height: 45px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; padding: 0 15px; flex: 1; transition: 0.2s; }
        .btn-primary { flex: 2 !important; background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-purple { background: var(--purple); color: white; display: none; }
        .btn-dice { background: var(--purple); color: white; display: none; width: 45px; flex: 0 !important; font-size: 1.2rem; opacity: 0.9; }
        .btn-danger { color: var(--danger); border: 1px solid var(--danger) !important; background: none; }

        .output-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .group-card { background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--card-border); box-shadow: 0 4px 6px var(--shadow); }
        .group-title { font-weight: bold; color: var(--primary); border: none; background: transparent; font-size: 1.1rem; width: 100%; cursor: pointer; border-bottom: 1px solid var(--card-border); margin-bottom: 10px; padding-bottom: 5px; }

        .student-item { padding: 8px; border-radius: 6px; transition: 0.2s; cursor: pointer; user-select: none; }
        .student-item.absent { opacity: 0.3; text-decoration: line-through; }
        .picking { background: var(--purple) !important; color: white !important; transform: scale(1.05); }
        .is-rep { color: var(--purple); font-weight: bold; }

        #modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:99999; }
        .modal { background:var(--container-bg); padding:25px; border-radius:16px; width:90%; max-width:500px; border: 1px solid var(--card-border); }
        #exportArea { width:100%; height:250px; margin:15px 0; padding:12px; box-sizing:border-box; font-family: monospace; background:var(--bg); color:var(--text); border:1px solid var(--card-border); border-radius:8px; resize: none; }

        #exitViewBtn { display: none; position: fixed; bottom: 30px; left: 30px; background: #333; color: white; padding: 12px 24px; border-radius: 30px; z-index: 10001; border: none; cursor: pointer; }
        body.student-view .header-row, body.student-view .grid-layout, body.student-view .settings-bar, body.student-view .btn-primary, body.student-view .btn-danger, body.student-view .btn-success { display: none !important; }
        body.student-view .container { background: transparent; box-shadow: none; }
        body.student-view #exitViewBtn { display: block; }
        body.student-view .controls { justify-content: center; }
        body.student-view .btn-purple, body.student-view .btn-dice { display: block !important; flex: 0 1 200px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h2>Group Generator</h2>
        <button onclick="toggleTheme()" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">ðŸŒ™</button>
    </div>

    <div class="grid-layout">
        <div class="editor-container">
            <div id="stealthOverlay"></div>
            <textarea id="inputData" oninput="handleInput()" onscroll="syncScroll()" placeholder="Paste names and grades here..."></textarea>
        </div>
        <div class="sidebar">
            <h4 style="margin:0 0 10px 0">Saved Classes</h4>
            <div id="savedList"></div>
        </div>
    </div>

    <div class="settings-bar">
        <select id="modeToggle" style="padding:8px; border-radius:6px; border:1px solid var(--card-border); background: var(--card-bg); color: var(--text);">
            <option value="per">Students per Group</option>
            <option value="total">Total Groups</option>
        </select>
        <input type="number" id="groupVal" value="3" min="1" style="width:60px; padding:8px; border-radius:6px; border:1px solid var(--card-border); background: var(--card-bg); color: var(--text);">
        <input type="text" id="className" placeholder="Class Name" style="flex:1; padding:8px; border-radius:6px; border:1px solid var(--card-border); background: var(--card-bg); color: var(--text);">
        <button onclick="saveClass()" style="background:var(--secondary); color:white; border-radius:6px; border:none; padding:8px 20px; cursor:pointer; font-weight:600;">Save</button>
    </div>

    <div class="controls">
        <button class="btn-primary" onclick="generateGroups()">Generate</button>
        <button class="btn-dice" onclick="renameAllGroups()" title="Randomize Team Names">ðŸŽ²</button>
        <button id="repBtn" class="btn-purple" onclick="pickRepresentatives()">Pick Reps</button>
        <button onclick="document.body.classList.toggle('student-view')">Student View</button>
        <button class="btn-success" onclick="openExport()">Export</button>
        <button class="btn-danger" onclick="resetWorkspace()">Reset</button>
    </div>

    <div id="output" class="output-container"></div>
</div>

<div id="modalOverlay">
    <div class="modal">
        <h3 style="margin-top:0">Export List</h3>
        <textarea id="exportArea" readonly></textarea>
        <div style="display:flex; gap:10px;">
            <button class="btn-primary" onclick="copyExport()">Copy to Clipboard</button>
            <button class="btn-secondary" onclick="document.getElementById('modalOverlay').style.display='none'" style="background:var(--secondary); color:white; border-radius:8px; border:none; flex:1;">Close</button>
        </div>
    </div>
</div>

<button id="exitViewBtn" onclick="document.body.classList.remove('student-view')">Editor (Esc)</button>

<script>
    let currentGroups = [];
    let isPicking = false;
    const funNames = ["The Brain Trust", "Calculated Chaos", "Smarty Pants", "Caffeine Cartel", "Logic Legends", "The Dream Team", "Goal Diggers", "Pixel Pioneers", "The Think Tank", "Syntax Squad", "Coffee Addicts", "The Nerd Herd", "Quantum Quirks", "Data Divas"];

    function handleInput() {
        const val = document.getElementById('inputData').value;
        document.getElementById('stealthOverlay').innerHTML = val.replace(/([0-9%.]+)/g, '<span class="ghost-num">$1</span>') + '\n';
        localStorage.setItem('lastText', val);
    }

    function syncScroll() { document.getElementById('stealthOverlay').scrollTop = document.getElementById('inputData').scrollTop; }

    function generateGroups() {
        const input = document.getElementById('inputData').value.trim();
        if (!input) return;

        let students = input.split('\n').map(line => {
            const parts = line.split(/\t| {2,}/);
            const name = parts[0].trim();
            let grade = parts.length >= 2 ? parseFloat(parts[1].replace(/[^0-9.]/g, '')) : 50;
            return { name, grade: isNaN(grade) ? 50 : grade, isRep: false, isAbsent: false };
        }).filter(s => s.name);

        students.sort((a, b) => b.grade - a.grade);

        const val = parseInt(document.getElementById('groupVal').value) || 1;
        const mode = document.getElementById('modeToggle').value;
        const numGroups = mode === 'per' ? Math.max(1, Math.ceil(students.length / val)) : val;

        let tempGroups = Array.from({ length: numGroups }, () => ({ members: [] }));

        students.forEach((s, i) => {
            let gIdx = i % numGroups;
            if (Math.floor(i / numGroups) % 2 === 1) gIdx = (numGroups - 1) - gIdx;
            tempGroups[gIdx].members.push(s);
        });

        tempGroups.forEach(g => g.members.sort(() => Math.random() - 0.5));
        tempGroups.sort(() => Math.random() - 0.5);

        currentGroups = tempGroups.map((g, i) => ({
            ...g,
            name: `Group ${i + 1}`
        }));

        renderGroups();
        document.getElementById('repBtn').style.display = 'block';
        document.getElementById('repBtn').innerText = "Pick Reps";
    }

    function renderGroups() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        currentGroups.forEach((g, gi) => {
            const card = document.createElement('div');
            card.className = 'group-card';
            card.innerHTML = `<input class="group-title" value="${g.name}" readonly onclick="renameOne(${gi})">
                <div class="student-list">${g.members.map((s, si) =>
                    `<div class="student-item ${s.isRep ? 'is-rep' : ''} ${s.isAbsent ? 'absent' : ''}"
                          onclick="toggleAttendance(${gi}, ${si})">
                        ${s.name}${s.isRep ? ' (Rep)' : ''}
                    </div>`).join('')}</div>`;
            out.appendChild(card);
        });
    }

    function toggleAttendance(gi, si) {
        if (isPicking) return;
        currentGroups[gi].members[si].isAbsent = !currentGroups[gi].members[si].isAbsent;
        // If they were rep, remove it
        if (currentGroups[gi].members[si].isAbsent) currentGroups[gi].members[si].isRep = false;
        renderGroups();
    }

    function renameOne(gi) {
        currentGroups[gi].name = funNames[Math.floor(Math.random() * funNames.length)] + ` (${gi + 1})`;
        renderGroups();
    }

    function renameAllGroups() {
        currentGroups.forEach((g, i) => g.name = funNames[Math.floor(Math.random() * funNames.length)] + ` (${i + 1})`);
        renderGroups();
    }

    async function pickRepresentatives() {
        if (isPicking || !currentGroups.length) return;
        isPicking = true;

        // Clear previous reps
        currentGroups.forEach(g => g.members.forEach(m => m.isRep = false));

        for (let i = 0; i < 12; i++) {
            document.querySelectorAll('.group-card').forEach((card, gi) => {
                const presentMembers = currentGroups[gi].members.filter(m => !m.isAbsent);
                if (presentMembers.length === 0) return;

                const items = card.querySelectorAll('.student-item:not(.absent)');
                items.forEach(el => el.classList.remove('picking'));
                if (items.length > 0) {
                    items[Math.floor(Math.random() * items.length)].classList.add('picking');
                }
            });
            await new Promise(r => setTimeout(r, 70 + (i * 20)));
        }

        currentGroups.forEach(g => {
            const presentIndices = g.members.map((m, idx) => m.isAbsent ? null : idx).filter(v => v !== null);
            if (presentIndices.length > 0) {
                const winnerIdx = presentIndices[Math.floor(Math.random() * presentIndices.length)];
                const winner = g.members.splice(winnerIdx, 1)[0];
                winner.isRep = true;
                g.members.unshift(winner); // Move rep to top
            }
        });

        isPicking = false;
        document.getElementById('repBtn').innerText = "New Reps";
        renderGroups();
    }

    function openExport() {
        if(!currentGroups.length) return;
        const text = currentGroups.map(g => `${g.name.toUpperCase()}\n${g.members.map(m => `â€¢ ${m.name}${m.isAbsent ? ' (Absent)' : ''}${m.isRep ? ' (Rep)' : ''}`).join('\n')}`).join('\n\n');
        document.getElementById('exportArea').value = text;
        document.getElementById('modalOverlay').style.display = 'flex';
    }

    function copyExport() {
        const area = document.getElementById('exportArea');
        area.select();
        document.execCommand('copy');
        alert("Groups copied to clipboard!");
    }

    function saveClass() {
        const name = document.getElementById('className').value || "Unnamed Class";
        const data = document.getElementById('inputData').value;
        if(!data) return;
        let classes = JSON.parse(localStorage.getItem('myClasses') || '[]');
        classes.push({ name, data });
        localStorage.setItem('myClasses', JSON.stringify(classes));
        renderSavedList();
    }

    function renderSavedList() {
        const classes = JSON.parse(localStorage.getItem('myClasses') || '[]');
        const list = document.getElementById('savedList');
        list.innerHTML = classes.map((c, i) => `<div class="saved-item"><span onclick="loadClass(${i})" style="flex:1">${c.name}</span><b onclick="delClass(${i})" style="color:red">&times;</b></div>`).join('');
    }

    function loadClass(i) {
        const c = JSON.parse(localStorage.getItem('myClasses'))[i];
        document.getElementById('inputData').value = c.data;
        handleInput();
    }

    function delClass(i) {
        let classes = JSON.parse(localStorage.getItem('myClasses'));
        classes.splice(i, 1);
        localStorage.setItem('myClasses', JSON.stringify(classes));
        renderSavedList();
    }

    function resetWorkspace() {
        if(confirm("Clear current groups and text? (Saved classes are safe)")) {
            document.getElementById('inputData').value = '';
            document.getElementById('output').innerHTML = '';
            currentGroups = [];
            handleInput();
        }
    }

    function toggleTheme() {
        const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    }

    window.onload = () => {
        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
        document.getElementById('inputData').value = localStorage.getItem('lastText') || '';
        handleInput();
        renderSavedList();
    };
</script>
</body>
</html>
